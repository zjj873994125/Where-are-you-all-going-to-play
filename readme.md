# 大家去哪玩 · 中点选址地图工具

> 一个帮助多人聚会找到最佳见面地点的 Web 工具

**当前版本：v1.3.1**

---

## 一、项目概述

### 1.1 项目背景

在日常生活中，经常会遇到以下场景：
- 多个朋友从不同地点出发，希望寻找一个**相对"中间"的聚会地点**
- 常见需求包括：一起吃饭、线下见面、临时集合

现有地图应用更偏向导航和单点搜索，对"多点取中 + 场所筛选"支持不足。因此需要一个**简单直观的中点选址工具**，帮助用户快速找到最合适的集合地点。

### 1.2 核心价值

- 快速计算**多点几何中点或交通时间加权中点**
- 一键搜索中点附近的**餐厅、咖啡厅、商场**等场所
- 查看场所详情并**直接导航**

### 1.3 目标用户

- 城市年轻人，经常线下聚会的朋友/同事
- 对地图操作熟悉的普通用户
- 不熟悉城市的游客

---

## 二、功能详解

### 2.1 地点添加模块

#### 功能描述
用户可以通过多种方式添加聚会参与者的位置。

#### 添加方式

| 方式 | 操作说明 |
|------|----------|
| **搜索地点** | 在搜索框输入地点名称或地址，从下拉列表选择 |
| **地图点击** | 直接在地图上点击位置，自动添加为"自定义点位" |
| **定位当前位置** | 点击工具栏"📍 定位"按钮，获取当前 GPS 位置 |
| **从收藏添加** | 点击"收藏夹"链接，从已收藏的地点中选择添加 |

#### 地点管理

- **显示标记**：每个地点显示为带字母的圆形标记（A、B、C...），最多支持 20 个地点
- **拖拽排序**：长按地点列表项左侧的拖拽手柄（⋮⋮），可以拖动调整顺序
- **删除地点**：点击地点右侧的删除按钮移除单个地点
- **清空所有**：点击"清空"按钮一次性移除所有地点
- **定位到地点**：点击地点列表项，地图自动平移到该地点位置
- **收藏地点**：点击星形图标收藏/取消收藏地点

#### 特殊标记

- **我的位置**：通过定位添加的位置显示为特殊的定位针样式，带有脉冲动画效果
- **收藏状态**：已收藏的地点星形图标显示为黄色实心

---

### 2.2 中点计算模块

#### 功能描述
当用户添加 2 个以上地点后，系统自动计算中心位置。

#### 计算模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **直线** | 几何中点，取所有点的经纬度平均值 | 快速估算，地点距离较近 |
| **驾车** | 根据驾车时间加权优化中点位置 | 参与者开车前往 |
| **公交** | 根据公交时间加权优化中点位置 | 参与者乘坐公共交通 |

#### 直线模式计算公式
```
中点纬度 = (lat1 + lat2 + ... + latN) / N
中点经度 = (lng1 + lng2 + ... + lngN) / N
```

#### 驾车/公交模式算法

1. 首先计算几何中点作为初始位置
2. 调用高德路径规划 API 获取每个点到中点的通勤时间
3. 根据时间差异计算权重（时间越长权重越大）
4. 迭代调整中点位置，使通勤时间更均衡
5. 最多迭代 3 次，当时间差异小于 5 分钟时停止

#### 通勤时间显示

- 驾车/公交模式下，地点列表会显示每个点到中点的预估时间
- 底部显示"平均 XX 分钟 · 差异 XX 分钟"汇总信息
- 点击汇总信息可查看每个点的详细通勤时间

#### 路线绘制

- 驾车/公交模式下，地图上会用虚线绘制每个点到中点的路线
- 不同路线使用不同颜色区分（蓝、绿、黄、红、紫等）

#### 失败处理

- 如果路径规划失败，会显示提示信息
- 如果所有路线都失败，自动回退到直线时间估算

---

### 2.3 附近搜索模块

#### 功能描述
基于计算出的中点位置，搜索附近合适的场所。

#### 搜索类型

系统预设 10 种常用场所类型：

| 类型 | 图标 | 颜色 |
|------|------|------|
| 餐厅 | 🍽️ | 橙色 |
| 咖啡厅 | ☕ | 橙色 |
| 奶茶店 | 🧋 | 橙色 |
| 商场 | 🛍️ | 紫色 |
| 酒吧 | 🍸 | 粉色 |
| 酒店 | 🏨 | 蓝紫色 |
| 医院 | 🏥 | 红色 |
| 地铁站 | 🚇 | 红色 |
| 公交站 | 🚌 | 绿色 |
| 火车站 | 🚂 | 蓝色 |

此外还支持**自定义关键词搜索**。

#### 搜索范围

可选范围：
- 500m（默认）
- 1km
- 2km
- 3km

搜索范围在地图上以红色半透明圆圈显示。

#### 自动重新搜索

- 切换搜索范围时，自动使用新范围重新搜索
- 中点位置变化时，自动重新搜索（防抖 200ms）

---

### 2.4 POI 详情模块

#### 功能描述
点击搜索结果中的场所，显示详细信息卡片。

#### 显示内容

| 字段 | 说明 |
|------|------|
| 名称 | 场所名称 |
| 类型 | 场所分类（如：餐饮服务;中餐厅） |
| 营业状态 | 营业中 / 休息中 / 营业状态未知 |
| 评分 | 用户评分（如：★ 4.5） |
| 人均消费 | 人均价格（如：¥58/人） |
| 地址 | 详细地址 |
| 营业时间 | 如：周一至周日 10:00-22:00 |
| 电话 | 商家联系电话（可点击拨打） |
| 照片 | 场所照片（支持左右切换浏览） |

#### 营业状态判断逻辑

系统会根据当前时间和营业时间自动判断：
1. 解析营业时间字符串（支持"周一至周五 09:00-18:00"等格式）
2. 判断当前是否在营业时间范围内
3. 支持跨天营业时间（如 22:00-02:00）

#### 操作按钮

- **📞 电话**：拨打商家电话
- **🧭 导航**：跳转高德地图导航到该地点

---

### 2.5 导航模块

#### 功能描述
点击 POI 详情卡片的"导航"按钮，跳转到高德地图进行导航。

#### 导航方式

支持三种导航模式：
- **驾车导航**：适合开车用户
- **步行导航**：适合距离较近的情况
- **公交导航**：适合乘坐公共交通

#### 跳转逻辑

1. **移动端**：优先唤起高德地图 APP
2. **PC 端 / APP 未安装**：在浏览器打开高德地图网页版

#### URL 格式

```
应用跳转：https://uri.amap.com/navigation?to=经度,纬度,地点名&mode=car&src=MeetPoint
网页跳转：https://ditu.amap.com/dir?type=car&to[lnglat]=经度,纬度&to[name]=地点名
```

---

### 2.6 城市切换模块

#### 功能描述
支持切换当前城市，影响搜索范围和地图视野。

#### 功能特性

- **自动定位**：首次进入自动获取当前城市
- **热门城市**：提供 20 个热门城市快速选择
- **城市搜索**：支持模糊搜索城市名称

#### 热门城市列表

北京、上海、广州、深圳、杭州、成都、重庆、武汉、西安、南京、苏州、天津、长沙、郑州、东莞、青岛、沈阳、大连、厦门、济南

#### 切换城市影响

- 地图视野自动移动到新城市中心
- 清空已添加的地点
- 清空搜索结果

---

### 2.7 收藏功能

#### 功能描述
收藏常用地点，方便下次快速添加。

#### 存储方式

使用浏览器 localStorage 本地存储，数据格式：
```json
{
  "id": "fav_1234567890",
  "name": "地点名称",
  "address": "详细地址",
  "lng": 116.397428,
  "lat": 39.90923,
  "favoriteTime": 1234567890000
}
```

#### 操作说明

- **收藏地点**：点击地点列表项右侧的星形图标
- **查看收藏**：点击搜索框下方的"收藏夹"链接
- **从收藏添加**：在收藏夹弹窗中点击"+"按钮
- **取消收藏**：在收藏夹弹窗中点击删除按钮

#### 去重规则

根据经纬度判断，相同位置不重复收藏。

---

### 2.8 分享功能

#### 功能描述
生成分享链接，其他人打开链接可还原完整会话状态。

#### 分享内容

分享链接包含以下状态：
- 已添加的所有地点
- 当前城市
- 搜索范围
- 中点计算模式
- 上次搜索的类型和关键词

#### 编码方式

使用 Base64 + URL 编码，格式：
```
https://域名/?share=BASE64编码的JSON数据
```

#### 使用方法

1. 点击工具栏"🔗 分享"按钮
2. 链接自动复制到剪贴板
3. 发送链接给朋友
4. 朋友打开链接自动还原状态

---

### 2.9 地图工具

#### 卫星地图

点击工具栏"🛰️ 卫星"按钮切换卫星视图，再次点击恢复普通地图。

#### 测距工具（仅 PC 端）

1. 点击工具栏"📏 测距"按钮进入测距模式
2. 在地图上点击放置起点
3. 继续点击添加更多节点
4. 双击或右键结束测距
5. 显示总距离

#### 定位功能

点击工具栏"📍 定位"按钮：
1. 获取当前 GPS 位置
2. 自动添加为"我的位置"
3. 如果 30 米内已有相同位置，提示"我的位置已在列表中"

---

### 2.10 AI 助手

#### 功能描述
内置 AI 助手，可以回答使用问题、排查故障、提供操作建议。

#### 支持的 AI 服务

| 服务商 | 模型 | 默认模型 |
|--------|------|----------|
| OpenAI | GPT 系列 | gpt-4o-mini |
| 智谱 AI | GLM 系列 | glm-4 |

#### BYOK 模式

用户需自行提供 API Key：
1. 选择服务商（GPT / 智谱）
2. 输入对应的 API Key
3. 可选：修改模型名称
4. 点击"保存"

API Key 仅保存在用户浏览器本地存储中，不会上传到服务器。

#### 上下文功能

勾选"发送当前状态"选项后，AI 助手会获取以下上下文：
- 应用版本
- 当前城市
- 中点计算模式
- 搜索范围
- 已添加的地点数量和名称
- 上次搜索类型和关键词

---

## 三、技术架构

### 3.1 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| 前端框架 | React | 19.0.0 |
| 类型系统 | TypeScript | 5.7.3 |
| 构建工具 | Vite | 6.0.11 |
| UI 组件库 | Ant Design | 6.2.1 |
| CSS 框架 | Tailwind CSS | 4.1.18 |
| 地图 | 高德地图 JS API | 2.0 |
| 拖拽 | dnd-kit | 6.3.1 |
| 工具库 | Lodash | 4.17.23 |

### 3.2 项目结构

```
src/
├── components/              # 组件目录
│   ├── AIAssistant.tsx        # AI 助手组件
│   ├── CitySelector.tsx       # 城市选择器
│   ├── Icon.tsx               # 阿里图标组件
│   ├── LocationPanel.tsx      # 地点面板（添加、列表、搜索）
│   ├── MapView.tsx            # 地图视图
│   ├── POIDetailCard.tsx      # POI 详情卡片
│   └── POIList.tsx            # POI 列表
├── hooks/                   # 自定义 Hooks
│   └── useFavorites.ts        # 收藏地点管理
├── types/                   # 类型定义
│   ├── amap.d.ts              # 高德地图类型声明
│   └── index.ts               # 业务类型定义
├── utils/                   # 工具函数
│   ├── amap.ts                # 高德地图 API 封装
│   └── mapCalc.ts             # 中点计算、距离计算、导航 URL 生成
├── App.tsx                  # 主应用组件
├── App.css                  # 全局样式
└── main.tsx                 # 应用入口
```

### 3.3 数据类型定义

#### LocationPoint（地点）
```typescript
interface LocationPoint {
  id: string           // 唯一标识
  name: string         // 地点名称
  address?: string     // 详细地址
  lng: number          // 经度
  lat: number          // 纬度
  travelTime?: number  // 到中点的通勤时间（分钟）
  isMyLocation?: boolean // 是否为"我的位置"
}
```

#### POI（兴趣点）
```typescript
interface POI {
  id: string           // POI ID
  name: string         // 名称
  address: string      // 地址
  lng: number          // 经度
  lat: number          // 纬度
  distance?: number    // 距中点距离（米）
  rating?: number      // 评分
  type?: string        // 类型
}
```

#### POIDetail（POI 详情）
```typescript
interface POIDetail extends POI {
  tel?: string              // 电话
  photos?: { url: string }[] // 图片数组
  openingHours?: string     // 营业时间
  openTimeRange?: string    // 营业时段（如 07:15-22:30）
  openTimeDescription?: string // 营业描述（如 周一至周日 07:15-22:30）
  averageCost?: number      // 人均消费（元）
  website?: string          // 网站
  cityname?: string         // 城市
  adname?: string           // 区域
  businessArea?: string     // 商圈
}
```

#### City（城市）
```typescript
interface City {
  name: string         // 城市名称
  adcode: string       // 行政区划代码
  center?: {           // 城市中心点
    lng: number
    lat: number
  }
}
```

#### 枚举类型
```typescript
// 搜索类型
type SearchType = '餐厅' | '咖啡厅' | '奶茶店' | '商场' | '酒吧' |
                  '酒店' | '医院' | '地铁站' | '公交站' | '火车站' | 'custom'

// 搜索范围
type SearchRadius = 500 | 1000 | 2000 | 3000

// 导航模式
type NavMode = 'drive' | 'walk' | 'bus'

// 中点计算模式
type MidPointMode = 'straight' | 'driving' | 'transit'
```

### 3.4 高德地图 API 使用

#### 使用的插件

| 插件名 | 用途 |
|--------|------|
| AMap.PlaceSearch | POI 搜索、关键词搜索、POI 详情 |
| AMap.Geolocation | 定位当前城市、获取当前位置 |
| AMap.Geocoder | 地理编码、逆地理编码 |
| AMap.AutoComplete | 城市搜索自动补全 |
| AMap.Driving | 驾车路径规划 |
| AMap.Transfer | 公交路径规划 |
| AMap.MarkerCluster | POI 点聚合 |
| AMap.RangingTool | 测距工具 |
| AMap.TileLayer.Satellite | 卫星地图图层 |

#### API 调用频率限制

- 路径规划：批量处理，每批 2 个请求，批次间隔 120ms
- 单次规划超时：12 秒
- POI 搜索：防抖 200ms

---

## 四、使用流程

### 4.1 基础流程

```
1. 进入网站
   ↓ 自动定位当前城市
2. 添加地点
   ↓ 搜索/点击地图/定位
3. 系统计算中点
   ↓ 添加 2 个以上地点后自动计算
4. 选择计算模式（可选）
   ↓ 直线/驾车/公交
5. 搜索附近场所
   ↓ 选择类型或输入关键词
6. 查看场所详情
   ↓ 点击搜索结果
7. 导航/拨打电话
```

### 4.2 分享流程

```
1. 添加多个地点
2. 点击"🔗 分享"按钮
3. 链接自动复制到剪贴板
4. 发送给朋友
5. 朋友打开链接
   ↓ 自动还原所有状态
```

---

## 五、常见问题解答（FAQ）

### 5.1 地点相关

**Q: 为什么搜索不到某个地点？**
A: 可能原因：
1. 关键词不够准确，尝试使用更完整的名称
2. 已切换到其他城市，该地点不在当前城市范围内
3. 该地点未被高德地图收录

**Q: 最多可以添加多少个地点？**
A: 最多支持 20 个地点。

**Q: 如何修改已添加的地点名称？**
A: 目前不支持修改名称，可以删除后重新添加。

### 5.2 中点计算相关

**Q: 为什么驾车/公交模式计算很慢？**
A: 驾车/公交模式需要调用高德路径规划 API，每个地点都要计算路线，所以耗时较长。

**Q: 为什么路线规划失败？**
A: 可能原因：
1. 网络连接问题
2. 高德 API 服务暂时不可用
3. 起点或终点位置无法规划（如在海上、山区等）
4. 起终点距离过远

**Q: 时间差异是什么意思？**
A: 时间差异 = 最大通勤时间 - 最小通勤时间，差异越小说明中点位置对大家越公平。

### 5.3 搜索相关

**Q: 为什么搜索结果为空？**
A: 可能原因：
1. 搜索范围太小，尝试扩大到 2km 或 3km
2. 该区域确实没有符合条件的场所
3. 关键词不够准确

**Q: 如何搜索其他类型的场所？**
A: 使用自定义关键词搜索，输入想要查找的场所类型，如"火锅"、"KTV"、"超市"等。

### 5.4 导航相关

**Q: 为什么导航没有唤起高德地图 APP？**
A: 可能原因：
1. 手机未安装高德地图 APP
2. 浏览器不支持唤起 APP（某些内置浏览器有限制）
3. 可以复制地址到高德地图 APP 中搜索

### 5.5 AI 助手相关

**Q: AI 助手需要付费吗？**
A: AI 助手使用 BYOK（Bring Your Own Key）模式，用户需要自行获取 API Key。OpenAI 和智谱 AI 的 API 使用都需要付费。

**Q: API Key 会被上传吗？**
A: 不会。API Key 仅保存在浏览器本地存储中，请求直接从浏览器发送到 AI 服务商。

**Q: 为什么 AI 助手请求失败？**
A: 可能原因：
1. API Key 无效或已过期
2. 账户余额不足
3. 网络连接问题
4. 模型名称填写错误

---

## 六、故障排查

### 6.1 地图加载失败

**症状**：页面空白或地图区域显示错误

**排查步骤**：
1. 检查网络连接
2. 清除浏览器缓存
3. 检查是否有广告拦截器阻止高德地图加载
4. 尝试刷新页面

### 6.2 定位失败

**症状**：点击定位按钮提示"定位失败"

**排查步骤**：
1. 检查浏览器是否允许该网站获取位置权限
2. 确保设备 GPS 已开启
3. 如果是 HTTPS 站点，确保安全连接
4. 尝试移动到开阔地带

### 6.3 路线规划失败

**症状**：驾车/公交模式无法显示路线

**排查步骤**：
1. 检查网络连接
2. 确认地点位置合理（不在海上、山区等）
3. 尝试减少地点数量
4. 切换到直线模式作为备选

### 6.4 分享链接无法恢复

**症状**：打开分享链接显示"分享链接无效或已损坏"

**可能原因**：
1. 链接被截断，确保复制完整
2. 链接格式被修改
3. 链接版本不兼容

---

## 七、版本历史

### v1.3.1（当前版本）
- POI 详情新增营业状态、人均消费、评分展示
- 支持解析 biz_ext 的 open_time、opentime2、cost、rating 字段
- 营业时间支持自动判断：营业中 / 休息中 / 营业状态未知
- 修复部分 POI 详情字段有值但前端显示为空的问题
- "我的位置"标记升级为定位针样式，带脉冲动画

### v1.3.0
- 新增 AI 助手功能（支持 OpenAI / 智谱 AI）
- 新增分享会话功能
- 新增测距工具（PC 端）

### v1.2.0
- 新增驾车/公交时间加权中点计算
- 新增路线绘制功能
- 新增地点拖拽排序
- 新增通勤时间统计显示

### v1.1.0
- 新增收藏地点功能
- 新增卫星地图切换
- 优化移动端适配
- 新增城市切换功能

### v1.0.0
- 基础功能：多点添加、几何中点计算
- 附近 POI 搜索
- POI 详情展示
- 跳转高德导航

---

## 八、部署说明

### 8.1 本地开发

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 预览生产版本
npm run preview
```

### 8.2 Docker 部署

详细文档请查看 [README.docker.md](README.docker.md)

```bash
# 本地部署
./deploy.sh deploy

# 远程部署
./deploy.sh remote

# Docker Compose
docker-compose up -d
```

访问地址：http://localhost:38080

### 8.3 高德地图 API Key 配置

1. 登录 [高德开放平台](https://lbs.amap.com/)
2. 创建应用，获取 Web 端 Key
3. 配置域名白名单（生产环境必须）
4. 在项目中配置 Key

---

## 九、注意事项

1. **高德 API 配额**：高德地图 API 有调用次数限制，生产环境需关注配额使用情况
2. **HTTPS 要求**：定位功能需要 HTTPS 环境
3. **浏览器兼容**：推荐使用 Chrome、Safari、Edge 等现代浏览器
4. **移动端适配**：已适配移动端，部分功能（测距）仅 PC 端可用

---

## 十、License

MIT
